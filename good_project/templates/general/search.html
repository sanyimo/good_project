{% extends "general/layout.html" %}
{% load i18n %}
{% load static %}

{% block head_title %}{% trans 'Buscar recetas' %}{% endblock %}
{% block page_title %}{% trans 'Buscar recetas'%}{% endblock %}

{% block content %}
<form method="get" action="{% url 'search' %}" class="search-form">
    {% if form.errors %}
        <div class="message error">
            <ul>
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
    {% endif %}
    <div class="basic-search">
        <label for="{{ form.q.id_for_label }}" class="visually-hidden">
            {% trans "Buscar recetas" %}
        </label>
        {{ form.q }}
        <button type="submit" class="btn btn__green">{% trans "Buscar" %}</button>
        <button type="button" id="toggle-filters">
            {% trans "Más filtros" %}<span  aria-hidden="true">
                <img class="toggle-icon" src="{% static 'img/embudo.svg' %}" alt="{% trans "Icono del filtro" %}" width="25" height="25" />
            </span>
        </button>    
    </div>
        
    <div class="advanced-filters">
        <fieldset>
            <legend>{% trans "Filtrar por dificultad y tiempo" %}</legend>
            <label for="{{ form.difficulty.id_for_label }}" class="visually-hidden">
                {% trans "Dificultad" %}
            </label>
            {{ form.difficulty }}
            <div class="shared">
                <label for="{{ form.prep_time_min.id_for_label }}" class="visually-hidden">
                    {% trans "Tiempo mínimo (min)" %}
                </label>
                {{ form.prep_time_min }}

                <label for="{{ form.prep_time_max.id_for_label }}" class="visually-hidden">
                    {% trans "Tiempo máximo (min)" %}
                </label>
                {{ form.prep_time_max }}
            </div>        
        </fieldset>

        <fieldset>
            <legend>{% trans "Categoría y método de cocción" %}</legend>
            <div class="shared">
                <label for="{{ form.category.id_for_label }}" class="visually-hidden">
                    {% trans "Categoría" %}
                </label>
                {{ form.category }}

                <label for="{{ form.cooking_methods.id_for_label }}" class="visually-hidden">
                    {% trans "Método de cocción" %}
                </label>
                {{ form.cooking_methods }}
            </div>
        </fieldset>

        <fieldset>      
            <legend>{% trans "Ingredientes - Excluir alérgenos" %}</legend>
            <div class="shared">
                <label for="{{ form.ingredients.id_for_label }}" class="visually-hidden">
                    {% trans "Ingredientes" %}
                </label>
                {{ form.ingredients }}
                
                <label for="{{ form.allergens.id_for_label }}" class="visually-hidden">
                    {% trans "Alérgenos" %}
                </label>
                {{ form.allergens }}
            </div>
        </fieldset>

        <fieldset>
            <legend>{% trans "Tipos de cocina y comida" %}</legend>
            <div class="shared">
                <label for="{{ form.cuisine_type.id_for_label }}" class="visually-hidden">
                    {% trans "Tipo de cocina" %}
                </label>
                {{ form.cuisine_type }}

                <label for="{{ form.allergens.id_for_label }}" class="visually-hidden">
                    {% trans "Alérgenos" %}
                </label>
                {{ form.meal_types }}
            </div>
        </fieldset>

        <fieldset>
            <legend>{% trans "Etiquetas" %}</legend>
            <label for="{{ form.tags.id_for_label }}" class="visually-hidden">
                {% trans "Etiquetas" %}
            </label>
            {{ form.tags }}
        </fieldset>
        
        <button type="submit"  class="btn btn__green apply-filters-btn">{% trans "Aplicar filtros" %}</button>
    </div>
</form>

{% if results is not None %}
    {% if results %}        
        {% if form.cleaned_data.q %}
            <h2>
                {% blocktrans with query=form.cleaned_data.q %}
                    Resultados para "{{ query }}"
                {% endblocktrans %}
            </h2>
        {% endif %}
        {% if filters_applied %}
            <p>
                {% trans "Filtros aplicados:" %} {{ filters_applied|join:", " }}
            </p>
        {% endif %}

        <div class="search-results">
            {% for recipe in results %}
                <div class="recipe-card">
                    <a href="{% url 'recipes:recipe_detail' recipe.slug %}">
                        <h3 class="recipe-title">{{ recipe.title }}</h3>
                        {% if recipe.photo and recipe.photo.url %}
                            <img src="{{ recipe.photo.url }}" alt="{{ recipe.title }}" class="recipe-img">
                        {% endif %}
                        <p class="recipe-meta">
                            {% if recipe.get_difficulty_display %}
                                {{ recipe.get_difficulty_display }}
                            {% endif %}
                            {% if recipe.prep_time %}
                                • {{ recipe.prep_time }} {% trans "min" %}
                            {% endif %}
                        </p>
                    </a>
                </div>
            {% endfor %}
        </div>        
    {% else %}
        <p>{% trans "No se encontraron resultados." %}</p>
    {% endif %}
{% endif %}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        $('.select2').select2({
            placeholder: "{% trans 'Selecciona o escribe para buscar' %}",
        allowClear: true,
        width: '100%'
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        const toggleBtn = document.getElementById('toggle-filters');
        const filters = document.querySelector('.advanced-filters');
        const icon = toggleBtn.querySelector('.toggle-icon');

        toggleBtn.addEventListener('click', () => {
        filters.classList.toggle('visible');
        const isVisible = filters.classList.contains('visible');
        // Cambia el texto visible, conservando el icono
        toggleBtn.childNodes[0].nodeValue = isVisible
            ? '{% trans "Menos filtros" %} '
            : '{% trans "Más filtros" %} ';

        toggleBtn.classList.toggle('open', isVisible);
        });
    });
    
</script>
{% endblock %}